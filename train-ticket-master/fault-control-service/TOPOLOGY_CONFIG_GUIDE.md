# 拓扑配置使用指南

## 概述

系统支持从JSON文件自动加载拓扑配置，您可以根据自己的需求配置不同的拓扑场景。

## 配置方式

### 1. JSON文件配置（推荐）

在 `src/main/resources/topologies/` 目录下创建JSON文件，文件名即为拓扑名称。

#### 文件结构
```
src/main/resources/topologies/
├── user-login.json          # 用户登录拓扑
├── ticket-query.json        # 车票查询拓扑
├── ticket-preserve.json     # 车票预售拓扑
├── food-service.json        # 订餐服务拓扑
└── advanced-query.json      # 车票高级查询拓扑
```

#### JSON格式模板
```json
{
  "name": "拓扑名称",
  "description": "拓扑描述",
  "nodes": [
    {
      "id": "节点ID",
      "name": "节点名称",
      "pureTime": 响应时间,
      "pureRate": "占比",
      "status": 状态,
      "type": "节点类型"
    }
  ],
  "edges": [
    {
      "source": "源节点ID",
      "target": "目标节点ID"
    }
  ]
}
```

### 2. 节点配置说明

#### 节点类型
- `browser`: 浏览器节点
- `java`: Java服务节点
- `MYSQL`: 数据库节点

#### 节点属性
- `id`: 节点唯一标识符
- `name`: 节点显示名称
- `pureTime`: 响应时间（毫秒），可为null
- `pureRate`: 占比（字符串格式）
- `status`: 状态（0: 正常, 1: 异常）
- `type`: 节点类型

### 3. 边配置说明

- `source`: 源节点ID
- `target`: 目标节点ID

## 现有拓扑配置

### 1. 用户登录 (user-login.json)
包含服务：网关服务、认证服务、用户服务、验证码服务、通知服务等

### 2. 车票查询 (ticket-query.json)
包含服务：基础服务、车站服务、列车服务、路线服务、旅行服务等

### 3. 车票预售 (ticket-preserve.json)
包含服务：预售服务、订单服务、座位服务、支付服务等

### 4. 订餐服务 (food-service.json)
包含服务：食品服务、车站食品服务、列车食品服务、食品配送服务等

### 5. 车票高级查询 (advanced-query.json)
包含服务：路线规划服务、旅行规划服务、旅行服务等

## 自定义配置

### 1. 创建新的拓扑配置

1. 在 `src/main/resources/topologies/` 目录下创建新的JSON文件
2. 按照模板格式配置节点和边
3. 重启应用或刷新拓扑页面

### 2. 修改现有配置

1. 编辑对应的JSON文件
2. 修改节点信息、边关系等
3. 重启应用或刷新拓扑页面

### 3. 配置示例

```json
{
  "name": "自定义拓扑",
  "description": "自定义拓扑图",
  "nodes": [
    {
      "id": "browser",
      "name": "browser",
      "pureTime": null,
      "pureRate": null,
      "status": 0,
      "type": "browser"
    },
    {
      "id": "00000000-1a2b-3c4d-0000-000012345678",
      "name": "ts-custom-service",
      "pureTime": 150.0,
      "pureRate": "0.1000",
      "status": 0,
      "type": "java"
    }
  ],
  "edges": [
    {
      "source": "browser",
      "target": "00000000-1a2b-3c4d-0000-000012345678"
    }
  ]
}
```

## 加载机制

### 1. 自动加载
- 应用启动时自动加载所有JSON配置文件
- 按文件名作为拓扑名称
- 支持热重载（需要重启应用）

### 2. 加载优先级
1. JSON文件配置（优先）
2. YAML配置（备用）
3. 示例拓扑（兜底）

### 3. 错误处理
- 单个文件加载失败不影响其他文件
- 所有文件加载失败时使用示例拓扑
- 详细的错误日志记录

## 故障注入支持

### 1. 服务名称处理
- 自动去掉 `chaos_` 前缀
- 支持带前缀和不带前缀的服务名称
- 在故障注入时使用处理后的服务名称

### 2. 节点点击
- 点击任意服务节点可进行故障注入
- 支持网络延迟故障
- 可设置延迟时间和持续时间

## 使用步骤

### 1. 配置拓扑
1. 编辑或创建JSON配置文件
2. 配置节点和边关系
3. 保存文件

### 2. 启动应用
```bash
mvn spring-boot:run
```

### 3. 访问拓扑页面
```
http://localhost:8090/topology
```

### 4. 选择拓扑
- 在下拉框中选择配置的拓扑
- 系统会自动加载对应的拓扑图

### 5. 故障注入
- 点击服务节点
- 选择故障类型
- 设置参数并应用

## 注意事项

1. **文件命名**: 文件名不要包含特殊字符
2. **JSON格式**: 确保JSON格式正确
3. **节点ID**: 节点ID必须唯一
4. **边关系**: 确保边的源节点和目标节点都存在
5. **服务名称**: 故障注入时会自动处理服务名称前缀

## 扩展功能

### 1. 添加新的节点类型
在拓扑页面CSS中添加新的节点类型样式

### 2. 添加新的故障类型
在ChaosMeshService中添加新的故障方法

### 3. 动态配置
支持通过API动态添加/修改拓扑配置 