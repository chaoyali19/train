# 压测功能使用指南

## 概述

本指南介绍如何在故障控制平台中使用压测功能来对Train-Ticket系统进行压力测试。

## 功能特点

- ✅ **Web界面操作**: 无需命令行，通过浏览器即可操作
- ✅ **实时监控**: 实时查看压测任务状态和输出日志
- ✅ **多场景支持**: 支持7种不同的压测场景
- ✅ **参数配置**: 可自定义并发数和总请求数
- ✅ **任务管理**: 支持启动、停止和监控多个任务

## 快速开始

### 1. 启动控制平台

```bash
cd fault-control-service
mvn spring-boot:run
```

### 2. 访问压测页面

打开浏览器访问：http://localhost:8080/stress

### 3. 配置压测参数

在压测配置区域：

1. **选择场景**: 从下拉菜单选择压测场景
2. **设置并发数**: 输入同时执行的请求数量（1-100）
3. **设置总请求数**: 输入要执行的总请求数量（1-10000）

### 4. 启动压测

点击"启动压测"按钮，系统会：
- 创建压测任务
- 异步执行Python压测程序
- 在任务监控区域显示任务状态

## 压测场景详解

### 1. high_speed - 高铁票查询
- **功能**: 模拟用户查询高铁票务信息
- **适用场景**: 测试高铁票查询接口的性能
- **建议参数**: 并发10-50，请求数100-1000

### 2. normal - 普通列车票查询
- **功能**: 模拟用户查询普通列车票务信息
- **适用场景**: 测试普通列车票查询接口的性能
- **建议参数**: 并发10-50，请求数100-1000

### 3. food - 食品查询
- **功能**: 模拟用户查询列车食品信息
- **适用场景**: 测试食品查询接口的性能
- **建议参数**: 并发5-20，请求数50-500

### 4. parallel - 并行车票查询
- **功能**: 模拟用户同时查询多种车票信息
- **适用场景**: 测试并发查询接口的性能
- **建议参数**: 并发20-100，请求数200-2000

### 5. pay - 查询并支付订单
- **功能**: 模拟用户查询车票并完成支付
- **适用场景**: 测试支付流程的性能
- **建议参数**: 并发5-20，请求数50-500

### 6. cancel - 查询并取消订单
- **功能**: 模拟用户查询车票并取消订单
- **适用场景**: 测试订单取消流程的性能
- **建议参数**: 并发5-20，请求数50-500

### 7. consign - 查询并添加托运信息
- **功能**: 模拟用户查询车票并添加托运信息
- **适用场景**: 测试托运流程的性能
- **建议参数**: 并发5-20，请求数50-500

## 任务状态说明

### 任务状态类型

- **启动中 (starting)**: 任务正在初始化
- **运行中 (running)**: 任务正在执行压测
- **已完成 (completed)**: 任务成功完成
- **失败 (failed)**: 任务执行失败
- **已停止 (stopped)**: 任务被手动停止

### 监控信息

每个任务显示以下信息：
- **任务ID**: 唯一标识符
- **场景**: 压测场景名称
- **状态**: 当前任务状态
- **并发数**: 设置的并发请求数
- **总请求数**: 设置的总请求数
- **运行时间**: 任务已运行的时间（秒）
- **输出日志**: 压测程序的实时输出
- **错误信息**: 如果任务失败，显示错误详情

## 操作指南

### 启动压测任务

1. 在压测配置区域选择场景
2. 设置合适的并发数和总请求数
3. 点击"启动压测"按钮
4. 系统会显示任务已启动的提示
5. 在任务监控区域查看任务状态

### 监控任务进度

1. 任务启动后会自动显示在任务监控区域
2. 系统每2秒自动刷新任务状态
3. 可以实时查看输出日志
4. 任务完成后状态会更新为"已完成"

### 停止运行中的任务

1. 在任务监控区域找到要停止的任务
2. 点击该任务下方的"停止任务"按钮
3. 系统会立即停止该任务
4. 任务状态会更新为"已停止"

### 刷新任务状态

1. 点击"刷新状态"按钮
2. 系统会重新获取所有任务的最新状态
3. 自动刷新功能会每2秒执行一次

## 配置说明

### Python环境配置

确保Python压测程序环境正确配置：

1. **检查Python项目路径**
   ```bash
   ls -la ../train-ticket-auto-query/
   ```

2. **检查Python虚拟环境**
   ```bash
   ls -la ../train-ticket-auto-query/.venv/bin/python
   ```

3. **安装Python依赖**
   ```bash
   cd ../train-ticket-auto-query/
   uv sync
   ```

### 配置文件

在 `application.yml` 中配置Python路径：

```yaml
stress:
  test:
    python:
      path: "../train-ticket-auto-query"  # 根据实际路径调整
    venv:
      path: "../train-ticket-auto-query/.venv/bin/python"  # 根据实际路径调整
```

## 故障排除

### 常见问题

#### 1. 启动压测失败
**症状**: 点击启动压测后显示"启动压测任务失败"
**可能原因**:
- Python项目路径配置错误
- Python环境未正确安装
- Python依赖未安装

**解决方法**:
1. 检查 `application.yml` 中的路径配置
2. 确认Python项目存在且可访问
3. 在Python项目目录执行 `uv sync` 安装依赖

#### 2. 任务状态不更新
**症状**: 任务启动后状态一直显示"启动中"
**可能原因**:
- Python程序执行出错
- 网络连接问题
- 权限问题

**解决方法**:
1. 检查任务输出日志中的错误信息
2. 确认Train-Ticket系统服务正常运行
3. 检查Python程序的执行权限

#### 3. 压测结果异常
**症状**: 压测完成但结果不符合预期
**可能原因**:
- 并发数设置过高
- 目标系统负载过高
- 网络延迟问题

**解决方法**:
1. 降低并发数重新测试
2. 检查目标系统资源使用情况
3. 检查网络连接质量

### 调试方法

#### 1. 查看应用日志
```bash
# 查看Spring Boot应用日志
tail -f logs/application.log
```

#### 2. 手动测试Python压测程序
```bash
cd ../train-ticket-auto-query/
python -m src.stress --scenario high_speed --concurrent 2 --count 5
```

#### 3. 检查网络连接
```bash
# 测试到目标系统的连接
curl -v http://train-ticket-server:port/health
```

## 最佳实践

### 1. 压测参数设置

- **小规模测试**: 并发5-10，请求数50-100
- **中等规模测试**: 并发10-50，请求数100-1000
- **大规模测试**: 并发50-100，请求数1000-10000

### 2. 监控要点

- **系统资源**: 监控CPU、内存、网络使用情况
- **响应时间**: 关注平均响应时间和P95/P99响应时间
- **错误率**: 监控请求失败率，通常应低于5%
- **吞吐量**: 关注QPS（每秒请求数）

### 3. 安全注意事项

- **避免过载**: 不要设置过高的并发数，避免目标系统过载
- **分时段测试**: 避免在业务高峰期进行大规模压测
- **监控告警**: 设置系统监控告警，及时发现问题

## 技术支持

如果遇到问题，请：

1. 查看应用日志获取详细错误信息
2. 检查Python压测程序的配置和依赖
3. 确认Train-Ticket系统服务状态
4. 参考本文档的故障排除部分

---

**注意**: 压测功能需要确保Python压测程序环境正确配置，并且Train-Ticket系统服务正常运行。 